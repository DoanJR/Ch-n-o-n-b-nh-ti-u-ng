import ssl
ssl._create_default_https_context = ssl._create_unverified_context

import re
from pathlib import Path
from docling.document_converter import DocumentConverter, PdfFormatOption
from docling.datamodel.pipeline_options import PdfPipelineOptions

# ==============================
# Cáº¤U HÃŒNH
# ==============================

pdf_file = "report.pdf"
output_dir = Path("report_docs")
doc_name = "rep"

PAGE_BREAK = "<!-- PAGE BREAK -->"
PAGE_LABEL_PREFIX = "<!-- PAGE: "

# ==============================
# Táº O THÆ¯ Má»¤C
# ==============================

output_dir.mkdir(exist_ok=True)
images_dir = output_dir / "images"
images_dir.mkdir(exist_ok=True)

print(f"ğŸš€ Äang xá»­ lÃ½: {pdf_file}")

# ==============================
# Cáº¤U HÃŒNH DOCILING
# ==============================

pipeline_options = PdfPipelineOptions()
pipeline_options.images_scale = 2.0
pipeline_options.generate_page_images = False
pipeline_options.generate_picture_images = True
pipeline_options.do_ocr = True   # báº­t náº¿u PDF scan

converter = DocumentConverter(
    format_options={
        "pdf": PdfFormatOption(pipeline_options=pipeline_options)
    }
)

# ==============================
# CONVERT PDF
# ==============================

result = converter.convert(pdf_file)
doc = result.document

print("ğŸ“„ ÄÃ£ convert PDF")

# ==============================
# TRÃCH XUáº¤T HÃŒNH PNG
# ==============================

picture_count = 0

for picture in doc.pictures:
    picture_count += 1
    img_path = images_dir / f"hinh_{picture_count}.png"
    img = picture.get_image(doc)
    img.save(img_path, "PNG")

print(f"ğŸ–¼ï¸ ÄÃ£ lÆ°u {picture_count} hÃ¬nh")

# ==============================
# EXPORT MARKDOWN (KHÃ”NG BASE64)
# ==============================

try:
    markdown_content = doc.export_to_markdown(
        page_break_placeholder=PAGE_BREAK,
        embed_images=False
    )
except TypeError:
    markdown_content = doc.export_to_markdown(
        page_break_placeholder=PAGE_BREAK
    )

# ==============================
# XÃ“A IMAGE BASE64 Náº¾U CÃ’N SÃ“T
# ==============================

markdown_content = re.sub(
    r'!\[.*?\]\(data:image.*?\)',
    '',
    markdown_content,
    flags=re.DOTALL
)

# ==============================
# CHÃˆN LABEL TRANG
# ==============================

parts = markdown_content.split(PAGE_BREAK)
parts_with_labels = []

for i, part in enumerate(parts, start=1):
    part = part.strip()
    if not part:
        continue
    parts_with_labels.append(
        f"{PAGE_LABEL_PREFIX}{i} -->\n\n{part}"
    )

markdown_content_paged = f"\n\n{PAGE_BREAK}\n\n".join(parts_with_labels)

# ==============================
# GHI FILE MARKDOWN
# ==============================

md_file = output_dir / f"{doc_name}_FULL_images_paged.md"

with open(md_file, "w", encoding="utf-8") as f:
    f.write(markdown_content_paged)

    if picture_count > 0:
        f.write("\n\n## ğŸ–¼ï¸ HÃŒNH áº¢NH TRÃCH XUáº¤T\n\n")
        for i in range(1, picture_count + 1):
            f.write(f"### HÃ¬nh {i}\n\n")
            f.write(f"![HÃ¬nh {i}](images/hinh_{i}.png)\n\n")

print("\nğŸ‰ HOÃ€N THÃ€NH!")
print(f"ğŸ“ ThÆ° má»¥c: {output_dir}/")
print(f"ğŸ“„ Markdown: {md_file}")
print(f"ğŸ–¼ï¸  Images: {images_dir}/")
print(f"ğŸ§± Page break marker: {PAGE_BREAK}")

print("\nğŸ‘‰ BÆ°á»›c tiáº¿p theo:")
print("1ï¸âƒ£ Zip toÃ n bá»™ thÆ° má»¥c report_docs/")
print("2ï¸âƒ£ Upload file zip vÃ o Dify Knowledge Base")
